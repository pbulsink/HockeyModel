<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2021 Updates • HockeyModel</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2021 Updates">
<meta property="og:description" content="HockeyModel">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">HockeyModel</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.2021</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic-usage.html">Basic Usage</a>
    </li>
    <li>
      <a href="../articles/model-description.html">Model Description</a>
    </li>
    <li>
      <a href="../articles/updates-2021.html">2021 Updates</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pbulsink/HockeyModel/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="updates-2021_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2021 Updates</h1>
            
            <h4 data-toc-skip class="date">2021-07-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pbulsink/HockeyModel/blob/HEAD/vignettes/updates-2021.Rmd" class="external-link"><code>vignettes/updates-2021.Rmd</code></a></small>
      <div class="hidden name"><code>updates-2021.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pbulsink/HockeyModel" class="external-link">HockeyModel</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The code has gone through a lot of changes for the 2021-2022 season. This article highlights those changes.</p>
</div>
<div class="section level2">
<h2 id="model-enhancements">Model Enhancements<a class="anchor" aria-label="anchor" href="#model-enhancements"></a>
</h2>
<p>The most significant part of the improvements for 2021 are enhancements to the model itself. A known issue was the under-performance of the model in predicting tie games. Looking at the prevalence of goals for tie games it was quickly apparent that the model under-predicted 2-2 and 3-3 ties significantly. While normally the model performs well in predictions of 2 or 3 goals for a team, the teams are motivated to play to a draw and take the game to overtime, as it guarantees them at least one point. By adding two factors (named <code>theta</code> and <code>gamma</code>), the chances of having a ‘regular time’ tie game are adjusted to match the actual.</p>
<p>Let’s demonstrate. I’ll select for games that are only included in the most recent model parameters. Then for all games that were ties (i.e. went to OT or SO for resolution) pulling the goals at which they were tied at the end of regulation time.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scores</span><span class="op">&lt;-</span><span class="va">scores</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">GameID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">GameID</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">'Goals'</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">Result</span> <span class="op">==</span> <span class="fl">0.25</span> <span class="op">~</span> <span class="va">.data</span><span class="op">$</span><span class="va">HomeGoals</span>,
                                             <span class="va">.data</span><span class="op">$</span><span class="va">Result</span> <span class="op">==</span> <span class="fl">0.4</span>  <span class="op">~</span> <span class="va">.data</span><span class="op">$</span><span class="va">HomeGoals</span>,
                                             <span class="va">.data</span><span class="op">$</span><span class="va">Result</span> <span class="op">==</span> <span class="fl">0.5</span>  <span class="op">~</span> <span class="va">.data</span><span class="op">$</span><span class="va">HomeGoals</span>,
                                             <span class="va">.data</span><span class="op">$</span><span class="va">Result</span> <span class="op">==</span> <span class="fl">0.6</span>  <span class="op">~</span> <span class="va">.data</span><span class="op">$</span><span class="va">AwayGoals</span>,
                                             <span class="va">.data</span><span class="op">$</span><span class="va">Result</span> <span class="op">==</span> <span class="fl">0.75</span> <span class="op">~</span> <span class="va">.data</span><span class="op">$</span><span class="va">AwayGoals</span>,
                                             <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_integer_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>From then, we can calculate the ratio of goals in regular games compared to goals in tied games. The <code>*2</code> adjusts because each tie game has two teams at that goal count.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">goalratios</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, 
                   FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">scores</span><span class="op">[</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span> <span class="op">==</span> <span class="va">x</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">scores</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">/</span>
                     <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">scores</span><span class="op">[</span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">HomeGoals</span> <span class="op">==</span> <span class="va">x</span> <span class="op">|</span> <span class="va">scores</span><span class="op">$</span><span class="va">AwayGoals</span> <span class="op">==</span> <span class="va">x</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">scores</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></code></pre></div>
<p>If we plot the goal ratios vs. score (in blue) we can see that they’re the same shape as a Weibull curve!</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">goalratios</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Goals"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">scores</span><span class="op">$</span><span class="va">Goals</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"GoalRatio"</span> <span class="op">=</span> <span class="va">goalratios</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">goalratios</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html" class="external-link">aes_string</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Goals"</span>, y<span class="op">=</span><span class="st">"GoalRatio"</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"Blue"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Goals"</span>, y<span class="op">=</span><span class="st">"Goal Ratio"</span>, title<span class="op">=</span><span class="st">"Goal Ratios"</span><span class="op">)</span></code></pre></div>
<p><img src="updates-2021_files/figure-html/plot_goalratios-1.png" width="700"></p>
<p>The new <code>eta</code>,<code>beta</code> and <code>k</code> factors produce a similarly shaped curve by developing a Weibull curve with shape and sacale values (distribution) equal to <code>eta</code> and <code>beta</code> respectively, and then multiplied the distribution by <code>k</code> to match the goal ratios. Plotted here (in red) you can see they match fairly well.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#goalratios$DistP&lt;-dpois(goalratios$Goals, lambda=HockeyModel::theta) * HockeyModel::gamma</span>
<span class="va">goalratios</span><span class="op">$</span><span class="va">DistW</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html" class="external-link">dweibull</a></span><span class="op">(</span><span class="va">goalratios</span><span class="op">$</span><span class="va">Goals</span>, shape<span class="op">=</span><span class="va">beta</span>, scale <span class="op">=</span> <span class="va">eta</span><span class="op">)</span> <span class="op">*</span> <span class="va">k</span>


<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">goalratios</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html" class="external-link">aes_string</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Goals"</span>, y<span class="op">=</span><span class="st">"GoalRatio"</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"Blue"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html" class="external-link">aes_string</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Goals"</span>, y<span class="op">=</span><span class="st">"DistW"</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"Green"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Goals"</span>, y<span class="op">=</span><span class="st">"Goal Ratio"</span>, title<span class="op">=</span><span class="st">"Model and Goal Ratios"</span><span class="op">)</span></code></pre></div>
<p><img src="updates-2021_files/figure-html/theta-1.png" width="700"></p>
<p>This could likely be better, but for now it’s better than before. The past predicted tie rate was about 17%. With this change, it’s up to 19%, but draws occur in about 23.5% of games.</p>
</div>
<div class="section level2">
<h2 id="data-sources">Data Sources<a class="anchor" aria-label="anchor" href="#data-sources"></a>
</h2>
<p>The model originally used a scraper that I had written for Hockey-Reference.com. While this worked well, changes in their website had, periodically, put the data unavailable until fixes were installed. The NHL has an API for accessing data directly from them, but until now I haven’t put that to use.</p>
<p>A package called <code>nhlapi</code> (available on <a href="https://cran.r-project.org/package=nhlapi" class="external-link"><code>CRAN</code></a> and <a href="https://github.com/jozefhajnala/nhlapi" class="external-link">GitHub</a>) has helped with this extensively. Unlike some other api access packages, this one is very lightweight. The code includes a complete adoption of this package and the removal of <a href="https://github.com/pbulsink/HockeyScrapR" class="external-link"><code>HockeyScrapR</code></a> as a dependency. <code>HockeyScrapR</code> will be retired.</p>
<p>This also provides some of the previously manual data, such as series limiting errors and having to scramble to get predictions up before games start.</p>
<p>We also now use conference and division assignments from the NHL instead of manually setting that up each year. Removal of hard coded data allows more time for improvements as less time is spent on updating these items.</p>
</div>
<div class="section level2">
<h2 id="playoff-cup-chances">Playoff / Cup Chances<a class="anchor" aria-label="anchor" href="#playoff-cup-chances"></a>
</h2>
<p>The way that playoff and Stanley Cup chances used to be calculated was based on the playoff format that the past few years had used. But both 2019-2020 and 2020-2021 used different formats (re-seeding, divisions/conferences, etc.). So the code now uses a slower, but more accurate and much more flexible. The new method is a Monte Carlo simulation, it simulates the playoffs millions of times to estimate the odds of each result.</p>
</div>
<div class="section level2">
<h2 id="odds-recording">Odds Recording<a class="anchor" aria-label="anchor" href="#odds-recording"></a>
</h2>
<p>Daily processing code records the predicted odds to a file (located at <code>./data-raw/dailyodds.csv</code>). This will help with calculating in-season metrics (log loss/accuracy), and in reading past day’s predictions. A helper function was also added that will clean up the file if there’s any duplicates (e.g. if a game gets postponed after the predictions are posted)</p>
</div>
<div class="section level2">
<h2 id="general-code-improvements">General Code Improvements<a class="anchor" aria-label="anchor" href="#general-code-improvements"></a>
</h2>
<p>The past two NHL seasons have been atypical, to say the least. It has highlighted the may assumptions that were baked into the code, such as the number of games in a season, the way that playoffs are seeded, etc. Many of those are fixed in this update.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Philip Bulsink.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
